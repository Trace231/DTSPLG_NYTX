# 多阶段复合抽样设计：估计纽约出租车平均费用

## 📊 设计概述

这是一个**三层嵌套的混合抽样设计**，结合了四种经典抽样方法，用于估计纽约出租车平均费用。

### 设计结构

```
总体（所有出租车行程）
  │
  ├─ 第一层：时间分层（Stratified by Time Period）
  │   └─ 按年份-季度分层（2009-Q1, 2009-Q2, ..., 2015-Q4）
  │
  ├─ 第二层：地理聚类（Clustered by Geographic Region）
  │   └─ 按上车位置经纬度，网格划分纽约市（10×10网格）
  │
  ├─ 第三层：乘客分层（Stratified by Passenger Count）
  │   └─ 1人、2人、3-4人、5人及以上
  │
  └─ 层内抽样：系统抽样（Systematic Sampling）
      └─ 按时间排序后等距抽样
```

---

## 🎯 为什么这个设计有新意？

### 1. **多层嵌套的统计理论意义**

这是一个**多阶段分层聚类抽样**（Multi-stage Stratified Cluster Sampling），在统计抽样理论中属于高级设计，很少在实际项目中完整实现。

- **分层抽样**：减少层间方差 → 提高估计精度
- **聚类抽样**：降低调查成本 → 提高操作效率
- **系统抽样**：保证时间均匀性 → 避免周期性偏差

### 2. **充分利用数据的多维特征**

你的数据有三个天然的分层/聚类维度：
- ⏰ **时间维度**：2009-2015，有明确的时间趋势
- 🗺️ **空间维度**：经纬度信息，有明确的地理异质性
- 👥 **人群维度**：乘客人数，影响车费水平

传统抽样通常只用1-2个维度，你这个设计**同时利用三个维度**。

### 3. **理论上的优势叠加**

```
设计效率 = 分层效应 × 聚类效应 × 系统抽样效应

分层效应：Var(ŷ_st) < Var(ŷ_srs)  (理论上)
聚类效应：成本降低，但可能增加方差
系统抽样：操作简单，若存在周期性可能更高效
```

---

## 📐 统计公式

### 分层抽样估计量

对于三层嵌套结构，总体均值估计为：

$$\bar{y}_{st} = \sum_{h=1}^{H} W_h \bar{y}_h$$

其中：
- $W_h = N_h / N$ 是第 $h$ 层的权重
- $\bar{y}_h$ 是第 $h$ 层样本均值
- $H$ 是总层数

### 方差估计

$$\text{Var}(\bar{y}_{st}) = \sum_{h=1}^{H} W_h^2 \frac{s_h^2}{n_h} (1 - f_h)$$

其中：
- $s_h^2$ 是第 $h$ 层样本方差
- $n_h$ 是第 $h$ 层样本量
- $f_h = n_h / N_h$ 是第 $h$ 层抽样比

### 设计效应（Design Effect）

$$\text{Deff} = \frac{\text{Var}(\bar{y}_{design})}{\text{Var}(\bar{y}_{srs})}$$

- Deff < 1：设计比简单随机抽样更高效 ✓
- Deff = 1：效率相当
- Deff > 1：设计效率较低（可能由于聚类效应）

---

## 🚀 设计优势分析

### 优势1：时间分层的统计优势

**为什么按时间分层？**

1. **捕获时间趋势**：不同年份/季度的车费水平可能不同（通胀、政策变化等）
2. **减少层间方差**：同层内车费更相似 → 估计更精确
3. **可以进行时间对比**：比如"2009年 vs 2015年"的平均车费变化

**理论保证**：如果层间差异大，分层抽样方差必然小于SRS。

### 优势2：地理聚类的操作优势

**为什么按地理聚类？**

1. **降低调查成本**：如果真的要实地调查，集中在某些区域更省钱
2. **反映空间异质性**：曼哈顿 vs 皇后区，车费模式可能不同
3. **符合实际场景**：很多社会调查就是这样做的（比如"抽几个街区"）

**注意**：聚类可能会增加方差（类内相关），但你的设计通过**在聚类内再分层**，部分抵消了这个劣势。

### 优势3：乘客分层的组间差异

**为什么按乘客人数分层？**

1. **组间差异明显**：1人出行 vs 5人出行，车费模式不同
2. **右偏分布**：大部分是1-2人，少数是多人 → 分层可以多抽尾部
3. **业务意义**：不同客群的消费特征

### 优势4：系统抽样的时间均匀性

**为什么层内用系统抽样？**

1. **保证时间分布均匀**：避免样本在某个时间段过度集中
2. **操作简单**：比完全随机抽样更容易执行
3. **周期性考虑**：如果出行有周期性（比如工作日vs周末），系统抽样可能更高效

---

## 🔬 可以进一步创新的点

### 1. **最优分配（Neyman Allocation）**

当前用的是比例分配，可以改成Neyman最优分配：

$$n_h \propto N_h \times \sigma_h$$

方差大的层多抽，方差小的层少抽 → 最小化总方差。

### 2. **PPS抽样（Probability Proportional to Size）**

地理聚类可以用PPS抽样：
- 订单数多的区域，抽取概率更大
- 适合估计"总车费"这种总量指标

### 3. **平衡重复抽样（Balanced Repeated Replication, BRR）**

对于复杂设计，可以用BRR估计方差，比传统的方差公式更稳健。

### 4. **事后分层（Post-Stratification）**

可以先抽样，再按某些变量分层调整权重，适合探索性分析。

---

## 📈 预期效果

### 与简单随机抽样（SRS）对比

| 指标 | SRS | 多阶段分层聚类抽样 |
|------|-----|-------------------|
| 估计精度 | 基准 | 理论上更高（分层效应） |
| 操作成本 | 高 | 低（聚类优势） |
| 方差估计 | 简单 | 复杂（但可计算） |
| 可解释性 | 简单 | 更丰富（可分析各层差异） |

### 可能的挑战

1. **聚类效应**：地理聚类可能增加方差（类内相关）
2. **样本量分配**：需要平衡三层结构，分配策略复杂
3. **方差估计**：需要考虑设计效应，公式较复杂

---

## 🎓 作业报告的亮点

1. ✅ **理论完备**：四种抽样方法都有明确的统计理论支撑
2. ✅ **设计新颖**：三层嵌套在实际应用中少见
3. ✅ **数据适配**：充分利用了数据的多维特征
4. ✅ **效果对比**：可以与SRS对比，展示设计优势
5. ✅ **可操作性**：每一步都有清晰的实现步骤

---

## 📝 实现建议

### 步骤1：数据探索
- 查看时间分布、地理分布、乘客人数分布
- 计算各维度的描述统计

### 步骤2：分层设计
- 确定时间分层的粒度（年？季度？月？）
- 确定地理网格的大小（10×10？20×20？）
- 确定乘客分层的边界（1, 2, 3-4, 5+？）

### 步骤3：样本量分配
- 计算每层的总体大小 $N_h$
- 分配样本量（比例分配 or Neyman分配）
- 确保每层至少有一个样本

### 步骤4：执行抽样
- 在每层内进行系统抽样
- 记录抽样过程（随机种子、抽样间隔等）

### 步骤5：估计与推断
- 计算分层估计量
- 估计方差和置信区间
- 计算设计效应

### 步骤6：结果对比
- 与SRS对比
- 与总体真实值对比
- 讨论设计优势与局限

---

## 🔗 参考文献建议

1. **Lohr, S. L. (2019).** Sampling: Design and Analysis (3rd ed.). 经典抽样教材
2. **Cochran, W. G. (1977).** Sampling Techniques (3rd ed.). 抽样理论奠基之作
3. **Kish, L. (1965).** Survey Sampling. 关于设计效应的经典讨论

---

祝你的抽样作业拿高分！🎉

